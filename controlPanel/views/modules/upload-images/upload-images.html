<style>
    .modal-img {
        display: none;
        position: fixed;
        padding-top: 100px;
        z-index: 2;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgb(0, 0, 0);
        background-color: rgba(0, 0, 0, 0.4);
    }
    
    .modal-content {
        display: block;
        background-color: white;
        margin: auto;
        padding: 10px;
        width: 80%;
        border: none;
        border-radius: 0px;
    }
    
    .img-container {
        padding: 0;
        cursor: pointer;
        height: 14em;
    }
    
    .img-container:hover .overlay {
        opacity: 1;
    }
    
    .placeholder-img {
        margin: 0;
        width: 100%;
        height: 100%;
    }
    
    .btn-cerrar-modal {
        float: right;
        cursor: pointer;
    }
    
    .clean-img {
        font-size: 1.3em;
        color: #808080;
        cursor: pointer;
        top: 0;
        right: 10px;
        position: absolute;
    }
    
    progress {
        opacity: 0.0;
        margin-top: 0.5em;
        border-radius: 0px;
        height: 0.5em;
        width: 100%;
    }
    
    progress::-webkit-progress-bar {
        background-color: #dddddd;
        border-radius: 2px;
    }
    
    progress::-webkit-progress-value {
        border-radius: 0px;
        background-color: #7DBA21;
    }
    
    progress::-moz-progress-bar {
        background-color: #dddddd;
        border-radius: 2px;
    }
    
    .overlay {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0%;
        right: 0;
        height: 100%;
        width: 100%;
        opacity: 0;
        transition: .2s ease;
        background-color: rgba(0, 0, 0, 0.2);
        cursor: pointer;
        pointer-events: none;
    }
    
    .text {
        font-weight: 500;
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        -webkit-transform: translate(-50%, -50%);
        -ms-transform: translate(-50%, -50%);
        transform: translate(-50%, -50%);
        text-align: center;
    }
    
    .boton-aceptar {
        background-color: #7DBA21;
        color: white;
        border-radius: 0px;
    }
</style>

<div class="modal-img" id="modal-img">

    <div class="modal-content" id="modal-content">
        <span id="btn-cerrar" onclick="cerrarModal()" class="btn-cerrar-modal"><i class="fa fa-times" style="color: #7DBA21;"></i></span>
        <div class="row">
            <div class="col-md-12 text-center mt-2">
                <h4>Agregar imágenes</h4>
            </div>
        </div>
        <form id="forma-img" action="" method="POST" enctype="multipart/form-data">
            <div class="row" style="padding: 25px;">

                <div class="col-md-1"></div>
                <div class="col-md-2 m-1 img-container">
                    <span class="clean-img" onclick="quitarImagen('img-1', 0, 'imagen-1')">&times;</i></span>
                    <img id="img-1" src="./views/img/placeholder.png" alt="placeholder" class="placeholder-img" onclick="abrirPrompt('imagen-1')">
                    <input accept='image/*' name="img-1" style="display: none;" type="file" id="imagen-1" onchange="previewImage(event, 'img-1', 0)">
                    <div class="overlay">
                        <div class="text">Agregar imagen</div>
                    </div>
                    <progress class="progress-bar-img" id="img-1" value="10" max="100"></progress>
                </div>
                <div class="col-md-2 m-1 img-container">
                    <span class="clean-img" onclick="quitarImagen('img-2', 1, 'imagen-2')">&times;</i></span>
                    <img id="img-2" src="./views/img/placeholder.png" alt="placeholder" class="placeholder-img" onclick="abrirPrompt('imagen-2')">
                    <input accept='image/*' name="img-2" style="display: none;" type="file" id="imagen-2" onchange="previewImage(event, 'img-2', 1)">
                    <div class="overlay">
                        <div class="text">Agregar imagen</div>
                    </div>
                    <progress class="progress-bar-img" id="img-1" value="10" max="100"></progress>
                </div>
                <div class="col-md-2 m-1 img-container">
                    <span class="clean-img" onclick="quitarImagen('img-3', 2, 'imagen-3')">&times;</i></span>
                    <img id="img-3" src="./views/img/placeholder.png" alt="placeholder" class="placeholder-img" onclick="abrirPrompt('imagen-3')">
                    <input accept='image/*' name="img-3" style="display: none;" type="file" id="imagen-3" onchange="previewImage(event, 'img-3', 2)">
                    <div class="overlay">
                        <div class="text">Agregar imagen</div>
                    </div>
                    <progress class="progress-bar-img" id="img-1" value="10" max="100"></progress>
                </div>
                <div class="col-md-2 m-1 img-container">
                    <span class="clean-img" onclick="quitarImagen('img-4', 3, 'imagen-4')">&times;</i></span>
                    <img id="img-4" src="./views/img/placeholder.png" alt="placeholder" class="placeholder-img" onclick="abrirPrompt('imagen-4')">
                    <input accept='image/*' name="img-4" style="display: none;" type="file" id="imagen-4" onchange="previewImage(event, 'img-4', 3)">
                    <div class="overlay">
                        <div class="text">Agregar imagen</div>
                    </div>
                    <progress class="progress-bar-img" id="img-1" value="10" max="100"></progress>
                </div>
                <div class="col-md-2 m-1 img-container">
                    <span class="clean-img" onclick="quitarImagen('img-5', 4, 'imagen-5')">&times;</i></span>
                    <img id="img-5" src="./views/img/placeholder.png" alt="placeholder" class="placeholder-img" onclick="abrirPrompt('imagen-5')">
                    <input accept='image/*' name="img-5" style="display: none;" type="file" id="imagen-5" onchange="previewImage(event, 'img-5', 4)">
                    <div class="overlay">
                        <div class="text">Agregar imagen</div>
                    </div>
                    <progress class="progress-bar-img" id="img-1" value="10" max="100"></progress>
                </div>
                <div class="col-md-1"></div>
            </div>

            <div class="row">
                <div class="col-md-12 text-center">
                    <button class="btn boton-aceptar" type="button" name="aceptar" onclick="sendToPhp()">Aceptar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    let cambios = ['no', 'no', 'no', 'no', 'no'];
    Object.seal(cambios);

    let modal = document.getElementById('modal-img');
    let botonCerrar = document.getElementById('btn-cerrar');

    idPropiedad = -1;

    let imagenes = ['', '', '', '', ''];
    Object.seal(imagenes);

    let nombreImagenes = ['', '', '', '', ''];
    Object.seal(nombreImagenes);

    function abrirPrompt(id) {
        let imagen = document.getElementById(id);
        imagen.click();
    }

    function previewImage(event, id, index) {

        let imagePreview = document.getElementById(id);

        if (event.target.files[0]) {
            imagenes[index] = event.target.files[0];
            imagePreview.src = URL.createObjectURL(event.target.files[0]);
            cambios[index] = 'si';
            let input = document.getElementById(`imagen-${index + 1}`);
            nombreImagenes[index] = input.value.split('\\', 3)[2];
        }
    }

    function quitarImagen(id, index, idInput) {

        let valor = document.getElementById(idInput);
        valor.value = "";

        let imagen = document.getElementById(id);
        imagen.src = './views/img/placeholder.png';

        imagenes[index] = "";
        nombreImagenes[index] = "";

        this.borrarImagen(index, idPropiedad);

    }

    function abrirModal(id, imagenes) {
        this.idPropiedad = id;
        let cosa;

        imagenes = Object.values(imagenes);
        for (let i = 0; i < imagenes.length; i++) {
            let imagenPreview = document.getElementById(`img-${i + 1}`);
            if (imagenes[i]) {
                imagenPreview.src = `./views/img/propiedades/${imagenes[i]}`;
            }
        }

        modal.style.display = 'block';
    }

    function cerrarModal() {

        for (let i = 0; i < imagenes.length; imagenes[i++] = "") {
            cambios[i] = "no";
            let input = document.getElementById(`imagen-${i + 1}`);
            input.value = "";

            let imagen = document.getElementById(`img-${i + 1}`);
            imagen.src = './views/img/placeholder.png';
        }

        modal.style.display = 'none';
    }


    botonCerrar.onclick = function() {
        cerrarModal();
    }

    let formaImagenes = document.getElementById('forma-img');

    function sendToPhp() {
        $.ajax({
            url: '../controlPanel/views/modules/upload-images/upload.php',
            type: "POST",
            data: function() {
                let cosa = new FormData(formaImagenes);
                cosa.append("idPropiedad", idPropiedad);
                cosa.append("cambios", cambios);
                cosa.append("nombres", nombreImagenes);
                return cosa;
            }(),
            success: function(data) {
                console.log(data);
                if (data.includes('success')) {
                    swal({
                        type: "success",
                        title: "¡Imágenes guardadas correctamente!",
                        showConfirmButton: true,
                        confirmButtonText: "Aceptar"

                    }).then(function(result) {
                        if (result.value) {
                            window.location = "index.php?action=mis-propiedades";
                        }
                    });
                } else if (data === "error") {
                    swal({
                        type: "error",
                        title: "No se pudieron subir las imágenes",
                        showConfirmButton: true,
                        confirmButtonText: "Aceptar"
                    });
                }

            },
            error: function(data) {
                console.log(data);
            },
            complete: function() {

            },
            cache: false,
            contentType: false,
            processData: false
        });
    }

    function getImages(id) {



        $.ajax({
            url: '../controlPanel/views/modules/upload-images/retrieve.php',
            type: "GET",
            data: `idPropiedad= ${id}`,
            success: function(data) {
                let datos;
                try {
                    datos = JSON.parse(data);
                } catch (error) {
                    console.log(error);
                }

                let imagenesServer = datos[0][0];

                try {
                    imagenesServer = JSON.parse(imagenesServer);
                } catch (error) {
                    console.log(error);
                }

                let valores = Object.values(imagenesServer);
                for (let i = 0; i < valores.length; i++) {
                    nombreImagenes[i] = valores[i];
                }


                abrirModal(id, imagenesServer);

            },
            error: function(data) {
                console.log(data);
            },
            complete: function() {

            },
            cache: false,
            contentType: false,
            processData: false
        });
    }

    function borrarImagen(index, id) {
        $.ajax({
            url: '../controlPanel/views/modules/upload-images/delete.php',
            type: 'POST',
            data: function() {
                let datos = new FormData();
                datos.append("indice", index);
                datos.append("idPropiedad", id);
                return datos;
            }(),
            success: function(data) {

            },
            error: function(data) {
                console.log(data);
            },
            complete: function() {

            },
            cache: false,
            contentType: false,
            processData: false
        });
    }
</script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>